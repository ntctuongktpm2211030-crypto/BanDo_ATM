<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bản đồ ngân hàng & ATM – Cần Thơ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- Chart.js & TurfJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html,body,#map{height:100%;margin:0;background:#070b13;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
    .card-like{background:linear-gradient(140deg,rgba(12,20,34,.85),rgba(8,14,24,.85));border:1px solid rgba(99,102,241,.18);border-radius:14px;box-shadow:0 10px 25px rgba(2,6,23,.35);backdrop-filter:blur(8px)}
    .leaflet-top.leaflet-left{display:flex;flex-direction:column;gap:10px;align-items:flex-start}

    .stats-panel{position:absolute;right:10px;top:10px;width:380px;max-height:85vh;overflow:auto;scrollbar-width:thin;scrollbar-color:rgba(99,102,241,.3) transparent;padding:10px;z-index:400;color:#e5e7eb;transition:width .2s ease}
    .stats-panel.collapsed{width:46px;padding:6px;overflow:visible}
    .stats-panel.collapsed .stats-body,.stats-panel.collapsed .stats-title-text{display:none}
    .stats-header{display:flex;justify-content:space-between;gap:8px}
    .stats-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .stats-controls label{display:flex;gap:6px;font-size:13px;opacity:.95;align-items:center}
    .stats-toggle{width:28px;height:28px;border:none;border-radius:8px;background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.35);display:grid;place-items:center;color:#e2e8f0;cursor:pointer}

    /* search box */
    .data-search{padding:10px;width:360px;border-radius:14px;transition:width .2s ease,height .2s ease;position:relative}
    .ds-wrap{display:flex;align-items:center;gap:6px}
    .ds-input{flex:1;height:42px;padding:0 44px 0 40px;border:1px solid rgba(148,163,184,.25);border-radius:12px;background:linear-gradient(180deg,#0b1220,#0a111e);color:#e5e7eb}
    .ds-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);color:#94a3b8;pointer-events:none}
    .ds-clear{position:absolute;right:118px;top:50%;transform:translateY(-50%);width:28px;height:28px;display:grid;place-items:center;border-radius:8px;border:1px solid rgba(148,163,184,.2);background:#0b1220;color:#cbd5e1;cursor:pointer;visibility:hidden;opacity:0;transition:.15s}
    .ds-clear.show{visibility:visible;opacity:1}
    .ds-btn{width:36px;height:36px;border:none;border-radius:10px;background:linear-gradient(180deg,#0f172a,#0c1424);color:#e5e7eb;display:grid;place-items:center;cursor:pointer;border:1px solid rgba(148,163,184,.25)}
    .ds-list{max-height:260px;overflow:auto;margin-top:8px;border-top:1px dashed rgba(148,163,184,.25);padding-top:6px}
    .ds-collapse-btn{position:absolute;top:50%;right:-48px;transform:translateY(-50%);width:34px;height:34px;border:none;border-radius:9999px;background:rgba(15,23,42,.65);border:1px solid rgba(148,163,184,.35);display:grid;place-items:center;color:#e2e8f0;cursor:pointer;z-index:999}
    .data-search.collapsed{width:46px;height:46px;padding:6px;display:flex;align-items:center;justify-content:center}
    .data-search.collapsed .ds-wrap,.data-search.collapsed .ds-list{display:none}

    .marker-icon-wrap{display:flex;justify-content:center;align-items:center;width:38px;height:38px;border-radius:50%}

    .gm-popup{width:310px;font-family:system-ui,sans-serif}
    .gm-header{padding-bottom:6px;border-bottom:1px solid #e2e8f0}
    .gm-title{font-weight:700;font-size:14.5px;margin-bottom:2px}
    .gm-sub{font-size:12px;color:#64748b}
    .gm-line{display:flex;gap:8px;margin:6px 0;font-size:12.5px;color:#0f172a}
    .leaflet-popup-content-wrapper,.leaflet-popup-tip{background:#fff;color:#0f172a}

    .legend .row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .legend .swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.18)}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- PANEL PHẢI -->
  <div id="stats-panel" class="stats-panel card-like">
    <div class="stats-header">
      <div class="stats-title-text">
        <div style="font-weight:700;">Thống kê ATM theo ngân hàng</div>
        <small style="opacity:.75">Nguồn: /api/atm</small>
            <div id="scopeLabel" style="margin-top:4px;opacity:.9"></div>

      </div>
      <div style="display:flex;gap:6px;">
        <button id="btn-refresh" class="ds-btn" title="Làm mới"><i class="fa-solid fa-arrows-rotate"></i></button>
        <button id="btn-stats-toggle" class="stats-toggle" title="Thu gọn/Mở rộng"><i class="fa-solid fa-angles-right"></i></button>
      </div>
    </div>

    <div class="stats-body">
      <div class="stats-controls">
        <label><input type="checkbox" id="chk-visible"/> Tổng ATM trong khung nhìn</label>
        <label><input type="checkbox" id="chk-choropleth" checked/> Tô màu theo khu vực</label>
        <label>Palette:
          <select id="paletteSelect">
            <option value="Spectral">Spectral (7)</option>
            <option value="YlOrRd">YlOrRd (7)</option>
            <option value="PuBuGn">PuBuGn (7)</option>
            <option value="Viridis">Viridis (7)</option>
            <option value="Turbo">Turbo (7)</option>
          </select>
        </label>
      </div>
      <canvas id="bankChart" height="160" style="margin-top:8px;"></canvas>
      <div id="legend" class="legend"></div>
    </div>
  </div>

  <script>
    // --- Chọn khu vực đang focus (ưu tiên cao hơn khung nhìn)
let selectedRegionLayer = null;   // L.Layer của polygon đang chọn
let selectedRegionCount = 0;      // số ATM trong khu vực chọn

function setScopeLabel(text) {
  const el = document.getElementById('scopeLabel');
  if (el) el.innerHTML = text || '';
}

// Reset chọn khu vực
function clearSelectedRegion() {
  selectedRegionLayer = null;
  selectedRegionCount = 0;
  setScopeLabel('');
}

    // ====== MAP & PANES ======
    const CT_CENTER = [10.0279603, 105.7664918];
    const map = L.map("map", { center: CT_CENTER, zoom: 12 });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // Pane riêng cho choropleth (nằm dưới marker)
    map.createPane("choro");
    map.getPane("choro").style.zIndex = 360;
    map.getPane("choro").style.pointerEvents = "auto";

    const colorATM  = '#ef4444';
    const colorBank = '#111827';
    const colorOther= '#eab308';

    // === ICONS cho ATM/BANK bằng SVG local ===
    // Đặt file tại /img/bank.svg và /img/atm-machine.svg
    const ICONS = {
      atm: L.icon({
        iconUrl: '/img/atm-machine.svg',
        iconSize: [32, 32],
        iconAnchor: [16, 30],
        popupAnchor: [0, -26],
        className: 'atm-icon'
      }),
      bank: L.icon({
        iconUrl: '/img/bank.svg',
        iconSize: [32, 32],
        iconAnchor: [16, 30],
        popupAnchor: [0, -26],
        className: 'bank-icon'
      }),
      other: L.divIcon({
        html:`<div class="marker-icon-wrap"><i class="fa-solid fa-location-dot" style="font-size:20px;color:${colorOther}"></i></div>`,
        iconSize:[38,38], className:''
      })
    };

    // iconWrap vẫn dùng để đánh dấu vị trí người dùng
    const iconWrap = color => L.divIcon({
      html:`<div class="marker-icon-wrap"><i class="fa-solid fa-location-dot" style="font-size:20px;color:${color}"></i></div>`,
      iconSize:[38,38], className:''
    });

    let geoLayer = null, featuresIndex = [], bankChart = null, userLocation = null;
    let boundaryLayer = null, boundaries = null;
    let pointsLoaded = false, boundariesLoaded = false;

    // ====== PALETTES (7 bậc) ======
    const PALETTES = {
      Spectral: ["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#e6f598","#66c2a5"],
      YlOrRd:   ["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#f03b20","#bd0026"],
      PuBuGn:   ["#f6eff7","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016450"],
      Viridis:  ["#440154","#482677","#3e4989","#31688e","#26828e","#1f9e89","#35b779"],
      Turbo:    ["#30123b","#4145ab","#2e8cff","#1ad4ff","#7dfb92","#f0f921","#f48e2a"]
    };
    function getPalette(){ return PALETTES[document.getElementById('paletteSelect').value] || PALETTES.Spectral; }

    const vnNormalize = s => s?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d') || '';

    function buildAddress(p){
      if (p.address) return p.address;
      if (p["addr:full"]) return p["addr:full"];
      const parts = [p["addr:housenumber"],p["addr:street"],p["addr:ward"]||p["addr:subdistrict"],p["addr:district"],p["addr:city"]||p["addr:province"]].filter(Boolean);
      return parts.length ? parts.join(", ") : null;
    }

    function atmArrayToGeoJSON(arr){
      return { type:"FeatureCollection", features:(arr||[]).filter(a=>a.lat&&a.lng).map(a=>({
        type:"Feature", geometry:{type:"Point",coordinates:[a.lng,a.lat]}, properties:{...a, amenity: a.amenity||"atm"}
      }))};
    }

    function popupDetail(p, latlng){
      const name = p.name || p.bank || "Điểm ATM";
      const addr = buildAddress(p) || "Không có địa chỉ";
      const phone = p.phone || p.contact_phone || "";
      const website = (p.website || p.url || "");
      const lat = latlng.lat, lng = latlng.lng;
      return `
        <div class="gm-popup">
          <div class="gm-header"><div class="gm-title">${name}</div></div>
          <div class="gm-line"><i class="fa-solid fa-location-dot"></i><div>${addr}</div></div>
          ${phone ? `<div class="gm-line"><i class="fa-solid fa-phone"></i><div><a href="tel:${phone}">${phone}</a></div></div>`:''}
          ${website ? `<div class="gm-line"><i class="fa-solid fa-globe"></i><div><a href="${website.startsWith('http')?website:'https://'+website}" target="_blank">${website}</a></div></div>`:''}
          <div class="gm-actions" style="display:flex;gap:10px;margin-top:8px;">
            <div class="gm-act"><div class="gm-act-btn btn-gmap" data-lat="${lat}" data-lng="${lng}" style="background:#14b8a6;width:36px;height:36px;border-radius:9999px;display:grid;place-items:center;color:#fff"><i class="fa-solid fa-route"></i></div></div>
            <div class="gm-act"><div class="gm-act-btn btn-share" data-lat="${lat}" data-lng="${lng}" style="background:#f59e0b;width:36px;height:36px;border-radius:9999px;display:grid;place-items:center;color:#fff"><i class="fa-solid fa-share-nodes"></i></div></div>
          </div>
        </div>`;
    }

    // ====== Helper XÁC ĐỊNH ATM & CHUẨN HOÁ TÊN NGÂN HÀNG ======
    function getIsATM(p = {}) {
      // Quy tắc theo yêu cầu: opening_hours null/undefined là ATM
      if (p.opening_hours === null || p.opening_hours === undefined) return true;

      // Fallback cho dữ liệu OSM/khác nguồn
      if (p.amenity === 'atm') return true;
      if (String(p.atm).toLowerCase() === 'yes') return true;

      return false;
    }

    function getBankName(p = {}) {
      let name = (p.bank || p.brand || p.operator || p['operator:en'] || p.name || 'Khác').trim();

      const norm = name
        .replace(/\s+/g, ' ')
        .replace(/\bngan\s*hang\b|\bngân\s*hàng\b|\bngân\s*hàng\b/gi, '') // bỏ "ngân hàng"
        .replace(/\(.*?\)/g, '')     // bỏ phần trong ngoặc
        .replace(/\s+-\s+.*/g, '')   // bỏ phần sau " - "
        .trim();

      const aliases = {
        'vietcombank': 'Vietcombank',
        'vcb': 'Vietcombank',
        'vietinbank': 'VietinBank',
        'bidv': 'BIDV',
        'agribank': 'Agribank',
        'techcombank': 'Techcombank',
        'mbbank': 'MB Bank',
        'mb': 'MB Bank',
        'acb': 'ACB',
        'sacombank': 'Sacombank',
        'tpbank': 'TPBank',
        'vpbank': 'VPBank',
        'shinhan': 'Shinhan Bank',
        'hsbc': 'HSBC',
        'standard chartered': 'Standard Chartered',
      };

      const key = norm.toLowerCase();
      for (const k in aliases) {
        if (key === k) return aliases[k];
      }

      // Viết hoa chữ cái đầu mỗi từ
      return norm.split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ') || 'Khác';
    }

    function renderMarkersFromGeoJSON(gj){
      if (geoLayer) map.removeLayer(geoLayer);
      featuresIndex = [];
      const markers = [];

      geoLayer = L.geoJSON(gj, {
        pointToLayer: (f, latlng) => {
          const p = f.properties || {};
          const isATM = getIsATM(p);
          const bankName = getBankName(p);

          const icon = isATM ? ICONS.atm : ICONS.bank;

          const m = L.marker(latlng, { icon });
          m.bindPopup(popupDetail(p, latlng));
          markers.push(m);

          const addrText = buildAddress(p) || '';
          featuresIndex.push({
            p,
            latlng,
            marker: m,
            isATM,
            bankName,
            text: vnNormalize([p.name, p.bank, bankName, addrText].join(' '))
          });

          return m;
        }
      }).addTo(map);

      if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds(), { padding:[20,20] });

      wireSearch();
      renderChart();
      pointsLoaded = true;
      ensureChoropleth();
    }

    async function fetchAndRender(){
      try {
        const res = await fetch("/api/atm");
        const arr = await res.json();
        renderMarkersFromGeoJSON(atmArrayToGeoJSON(arr));
      } catch(e){ console.error("Không tải được /api/atm", e); }
    }

    // ====== SEARCH UI ======
    const SearchControl = L.Control.extend({
      options:{position:'topleft'},
      onAdd:function(){
        const wrap = L.DomUtil.create('div','data-search card-like');
        L.DomEvent.disableClickPropagation(wrap);
        wrap.innerHTML = `
          <div class="ds-wrap">
            <i class="fa-solid fa-magnifying-glass ds-icon"></i>
            <input id="ds-input" class="ds-input" placeholder="Tìm (tên/brand/địa chỉ)">
            <button id="ds-clear" class="ds-clear">&times;</button>
            <button id="btn-reset" class="ds-btn" title="Reset"><i class="fa-solid fa-rotate-right"></i></button>
            <button id="btn-locate" class="ds-btn" title="Vị trí của tôi"><i class="fa-solid fa-location-crosshairs"></i></button>
          </div>
          <button id="ds-collapse" class="ds-collapse-btn" title="Thu gọn/Mở rộng"><i class="fa-solid fa-chevron-left"></i></button>
          <div id="ds-list" class="ds-list"></div>`;
        return wrap;
      }
    });
    map.addControl(new SearchControl());

    function wireSearch(){
      const input=document.getElementById('ds-input'), list=document.getElementById('ds-list'), clear=document.getElementById('ds-clear');
      if(!input) return;
      input.oninput=()=>{
        const val=vnNormalize(input.value.trim());
        clear.classList.toggle('show',!!val); list.innerHTML=''; if(!val) return;
        const rs=featuresIndex.filter(f=>f.text.includes(val)).slice(0,30);
        rs.forEach(({p,latlng,marker,bankName,isATM})=>{
          const row=document.createElement('div');
          row.className='ds-item';
          row.style.cursor='pointer';
          row.style.display='grid';
          row.style.gridTemplateColumns='20px 1fr';
          row.style.alignItems='start';
          row.style.gap='8px';
          row.innerHTML=`
            <i class="fa-solid fa-${isATM?'building-columns':'university'}"></i>
            <div><b>${p.name||bankName||p.bank||'ATM'}</b><br><small>${buildAddress(p)||''}</small></div>`;
          row.onclick=()=>{map.setView(latlng,17);marker.openPopup();};
          list.appendChild(row);
        });
        if(!rs.length) list.innerHTML='<div class="ds-item"><i class="fa-regular fa-circle-xmark"></i> Không tìm thấy</div>';
      };
      clear.onclick=()=>{input.value='';clear.classList.remove('show');list.innerHTML='';};
    }

    // ====== CHART ======
    function aggregateByBank() {
  const onlyVisible = document.getElementById('chk-visible')?.checked;
  const bounds = map.getBounds();

  // Nếu có khu vực được chọn thì dùng khu vực, bỏ qua khung nhìn
  const usingRegion = (document.getElementById('chk-choropleth')?.checked) && !!selectedRegionLayer;
  const regionFeature = usingRegion ? selectedRegionLayer.feature : null;

  const counts = {};

  for (const f of featuresIndex) {
    if (!f.isATM) continue; // chỉ tính ATM

    // Ưu tiên lọc theo khu vực nếu đang chọn khu vực
    if (usingRegion) {
      const pt = turf.point([f.latlng.lng, f.latlng.lat]);
      if (!turf.booleanPointInPolygon(pt, regionFeature)) continue;
    } else if (onlyVisible) {
      // Nếu không chọn khu vực mà bật "khung nhìn"
      if (!bounds.contains(f.marker.getLatLng())) continue;
    }

    const key = f.bankName || 'Khác';
    counts[key] = (counts[key] || 0) + 1;
  }

  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, 20);

  // Cập nhật nhãn phạm vi
  if (usingRegion) {
    const name = selectedRegionLayer?.feature?.properties?.name || 'Khu vực';
    const total = sorted.reduce((s, [,v])=>s+v, 0);
    selectedRegionCount = total;
    setScopeLabel(`<small><b>Phạm vi:</b> ${name} — <b>${total}</b> ATM</small>`);
  } else if (onlyVisible) {
    const total = sorted.reduce((s, [,v])=>s+v, 0);
    setScopeLabel(`<small><b>Phạm vi:</b> Khung nhìn — <b>${total}</b> ATM</small>`);
  } else {
    const total = sorted.reduce((s, [,v])=>s+v, 0);
    setScopeLabel(`<small><b>Phạm vi:</b> Toàn bộ — <b>${total}</b> ATM</small>`);
  }

  return { labels: sorted.map(x=>x[0]), data: sorted.map(x=>x[1]) };
}

    function renderChart(){
      const ctx = document.getElementById('bankChart');
      if (!ctx) return;
      const { labels, data } = aggregateByBank();
      if (bankChart) bankChart.destroy();

      bankChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Số ATM',
            data,
            backgroundColor: 'rgba(99, 102, 241, 0.45)',
            borderColor: 'rgba(99, 102, 241, 0.9)',
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(148,163,184,.15)' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#e5e7eb', precision: 0, stepSize: 1 },
              grid: { color: 'rgba(148,163,184,.15)' }
            }
          }
        }
      });
    }

    // ====== RANH GIỚI & CHOROPLETH ======
    async function loadBoundaries(){
      try{
        const res=await fetch("/data/ranhgioi.geojson");
        boundaries=await res.json();
        if(boundaryLayer) map.removeLayer(boundaryLayer);
        boundaryLayer=L.geoJSON(boundaries,{pane:"choro",style:{color:"#0ea5e9",weight:1,fillOpacity:0}}).addTo(map);
        // Lắng nghe click để chọn khu vực -> biểu đồ sẽ thống kê trong khu vực đó
boundaryLayer = L.geoJSON(boundaries, {
  pane: "choro",
  style: defaultRegionStyle,
  onEachFeature: (feature, layer) => {
    layer.on("click", () => {
      selectedRegionLayer = layer; // chọn khu vực

      if (document.getElementById("chk-choropleth")?.checked) {
        highlightSelectedRegion(); // chỉ tô đúng khu vực đang chọn
      }

      try { map.fitBounds(layer.getBounds(), { padding: [20, 20] }); } catch {}
      renderChart();
    });
  }
}).addTo(map);

boundaryLayer.bringToFront();

        boundariesLoaded = true;
        ensureChoropleth();
      }catch(e){
        console.error("Không tải được ranh giới:",e);
        document.getElementById("legend").textContent="Không có ranh giới khu vực.";
      }
    }

    function quantileBreaks(values, k=7){
      const arr = values.slice().sort((a,b)=>a-b);
      const qs=[]; for(let i=1;i<k;i++){ const p=i/k; qs.push(arr[Math.floor(p*(arr.length-1))] ?? 0); }
      return qs; // length k-1
    }
    function classifyQuantile(x, breaks){ let c=0; while(c<breaks.length && x>breaks[c]) c++; return c; }

    function colorizeChoropleth(){
      if(!boundaryLayer || !featuresIndex.length) return;

      const pts = turf.featureCollection(featuresIndex.filter(f=>f.isATM).map(f=>turf.point([f.latlng.lng,f.latlng.lat])));
      const counts=[], cache=new Map();

      boundaryLayer.eachLayer(l=>{
        const n = turf.pointsWithinPolygon(pts, l.feature).features.length;
        cache.set(l._leaflet_id, n);
        counts.push(n);
      });

      const palette = getPalette(); // 7 màu
      const breaks  = quantileBreaks(counts, palette.length);

      boundaryLayer.eachLayer(l=>{
        const n = cache.get(l._leaflet_id) || 0;
        const cls = classifyQuantile(n, breaks); // 0..6
        l.setStyle({fill:true, fillOpacity:0.7, fillColor:palette[cls], color:"#0ea5e9", weight:1});
        const name = l.feature?.properties?.name || "Khu vực";
        l.bindTooltip(`${name}: ${n} ATM`, {sticky:true});
      });

      // legend
      let html='';
      for(let i=0;i<palette.length;i++){
        const label = i===0 ? `≤ ${breaks[0]||0}`
                    : (i===palette.length-1 ? `> ${breaks[i-1]||0}`
                    : `${(breaks[i-1]||0)+1} – ${breaks[i]}`);
        html += `<div class="row"><span class="swatch" style="background:${palette[i]}"></span> ${label}</div>`;
      }
      document.getElementById('legend').innerHTML = html + `<small>Màu theo phân vị (quantile) số ATM/khu vực.</small>`;
    }
function ensureChoropleth(){
  const on = document.getElementById('chk-choropleth')?.checked;
  if (!on || !pointsLoaded || !boundariesLoaded) return;

  // Nếu đang có khu vực được chọn -> chỉ giữ highlight khu vực đó,
  // KHÔNG vẽ lại phân vị cho toàn bản đồ (tránh đè style highlight).
  if (selectedRegionLayer) {
    highlightSelectedRegion();
    return;
  }

  // Không có khu vực đang chọn -> cứ tô phân vị toàn bản đồ như cũ
  colorizeChoropleth();
}

const defaultRegionStyle = { color: "#0ea5e9", weight: 1, fill: true, fillOpacity: 0 };

function unhighlightAll() {
  if (!boundaryLayer) return;
  boundaryLayer.resetStyle(); // trả mọi khu vực về style mặc định
}

function highlightSelectedRegion() {
  if (!boundaryLayer) return;
  unhighlightAll();
  if (selectedRegionLayer) {
    selectedRegionLayer.setStyle({
      fill: true,
      fillOpacity: 0.85,
      fillColor: "#f59e0b",
      weight: 2,
      color: "#38bdf8"
    });
    selectedRegionLayer.bringToFront();
  }
}


    // ====== EVENTS ======
    document.addEventListener('click', (e)=>{
      if(e.target.closest('#ds-collapse')){
        const box=e.target.closest('.data-search'); box.classList.toggle('collapsed');
        const i=e.target.querySelector('i'); i.className = box.classList.contains('collapsed')?'fa-solid fa-magnifying-glass':'fa-solid fa-chevron-left';
      }
      if(e.target.closest('#btn-reset')) map.setView(CT_CENTER,12);
      if(e.target.closest('#btn-locate')){
        if(!navigator.geolocation){ alert('Trình duyệt không hỗ trợ định vị'); return; }
        navigator.geolocation.getCurrentPosition(({coords})=>{
          const here=[coords.latitude,coords.longitude]; userLocation=here;
          L.marker(here,{icon:iconWrap('#22c55e')}).addTo(map).bindPopup(`<b>Vị trí của bạn</b><br/>±${Math.round(coords.accuracy)}m`).openPopup();
          map.setView(here,16);
        }, err=>alert('Không lấy được vị trí: '+err.message));
      }
      if(e.target.closest('.btn-gmap')){
        const btn=e.target.closest('.btn-gmap'); const lat=btn.dataset.lat,lng=btn.dataset.lng;
        const url=userLocation?`https://www.google.com/maps/dir/?api=1&origin=${userLocation[0]},${userLocation[1]}&destination=${lat},${lng}`:`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(url,'_blank');
      }
      if(e.target.closest('.btn-share')){
        const btn=e.target.closest('.btn-share'); const lat=btn.dataset.lat,lng=btn.dataset.lng;
        const url=`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`; navigator.clipboard?.writeText(url); alert('Đã copy link: '+url);
      }
    });

    document.getElementById('btn-stats-toggle').onclick=()=>{
      const panel=document.getElementById('stats-panel'); panel.classList.toggle('collapsed');
      document.querySelector('#btn-stats-toggle i').className = panel.classList.contains('collapsed')?'fa-solid fa-angles-left':'fa-solid fa-angles-right';
    };
    document.getElementById('btn-refresh').onclick=()=>fetchAndRender();
    document.getElementById('chk-visible').onchange = ()=>renderChart();
document.getElementById('chk-choropleth').onchange = (e) => {
  if (e.target.checked) {
    // Nếu đã chọn sẵn 1 khu vực thì tô nó; nếu chưa chọn thì tất cả trong suốt
    highlightSelectedRegion();
  } else {
    // Tắt: bỏ tô toàn bộ, bỏ chọn khu vực
    unhighlightAll();
    clearSelectedRegion();
  }
  renderChart();
};



    document.getElementById('paletteSelect').onchange=()=>ensureChoropleth();

    // Cập nhật biểu đồ khi pan/zoom để bám theo khung nhìn (và luôn đồng bộ)
// Nhấp phải để xóa chọn khu vực
map.on('contextmenu', () => {
  if (selectedRegionLayer) {
    clearSelectedRegion();
    unhighlightAll();   // bỏ tô hết
    renderChart();
  }
});


// Khi pan/zoom, nếu đang chọn khu vực thì vẫn thống kê theo khu vực
map.on('moveend zoomend', () => {
  renderChart();
});


    // ====== INIT ======
    map.whenReady(()=>{
      loadBoundaries();
      fetchAndRender();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => { userLocation=[pos.coords.latitude,pos.coords.longitude]; });
      }
    });

    // Auto reload ATM mỗi phút (nếu muốn)
    setInterval(fetchAndRender, 60000);
  </script>
</body>
</html>
